name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: liberica
          java-version: '21'

      - name: Install Google Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Cache Gradle Node downloads
        uses: actions/cache@v4
        with:
          path: |
            .gradle/nodejs
            .gradle/npm
          key: ${{ runner.os }}-gradle-node-${{ hashFiles('build.gradle', 'src/ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-gradle-node-

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Verify Gradle
        run: .\gradlew.bat --version

      - name: Run UI validation (lint, typecheck, unit tests)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          .\gradlew.bat uiCheck --no-daemon --stacktrace *>&1 | Tee-Object -FilePath build\ci-ui-check.log
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Build project (Java + UI)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          .\gradlew.bat build --no-daemon --stacktrace --info *>&1 | Tee-Object -FilePath build\ci-build.log
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ github.run_id }}
          path: |
            build/reports/**
            build/test-results/**
            build/logs/**
            build/ci-*.log
            src/ui/coverage/**
          if-no-files-found: warn
          retention-days: 7

  package-app-image:
    needs: build-and-test
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x86, x64]
        include:
          - arch: x86
            label: win32
            gradle_opts: "-Xmx512m"
          - arch: x64
            label: win64
            gradle_opts: "-Xmx2g"
    env:
      GRADLE_OPTS: ${{ matrix.gradle_opts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21 (${{ matrix.arch }})
        uses: actions/setup-java@v4
        with:
          distribution: liberica
          java-version: '21'
          architecture: ${{ matrix.arch }}

      - name: Cache Gradle Node downloads
        uses: actions/cache@v4
        with:
          path: |
            .gradle/nodejs
            .gradle/npm
          key: ${{ runner.os }}-gradle-node-${{ hashFiles('build.gradle', 'src/ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-gradle-node-

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build app image zip
        run: .\gradlew.bat appImageZip --no-daemon --stacktrace

      - name: Sanitize ref name for artifact
        shell: pwsh
        run: |
          $safe = $env:GITHUB_REF_NAME -replace '/', '-'
          echo "REF_SAFE=$safe" >> $env:GITHUB_ENV

      - name: Upload app image artifact (${{ matrix.label }})
        uses: actions/upload-artifact@v4
        with:
          name: scoreboard-app-image-${{ matrix.label }}-${{ env.REF_SAFE }}-${{ github.sha }}
          path: build/artifacts/*.zip
          if-no-files-found: error
          retention-days: 14
