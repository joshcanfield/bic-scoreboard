// Plugins (must be declared first)
plugins {
    id 'java'
    id 'idea'
    id 'groovy'
    id 'application'
    // For creating a custom runtime and Windows installers/app images
    id 'org.beryx.jlink' version '3.1.1'
    // For creating a fat JAR used by the fallback jpackage task
    id 'com.github.johnrengelman.shadow' version '8.1.1'
    // For integrating Node/npm build into Gradle workflow
    id 'com.github.node-gradle.node' version '7.1.0'
}

java {
    sourceCompatibility = JavaVersion.VERSION_21
    targetCompatibility = JavaVersion.VERSION_21
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

description = "Bremerton Ice Arena ScoreBoard"
group = "canfield.josh"
version = "2.0"

application {
    mainClass = 'canfield.bia.ServiceMain'
}

project.ext {
    // Jetty 11 uses Jakarta Servlet API (required for RESTEasy 6)
    jetty = [version: "11.0.24"]
    // RESTEasy 6 uses Jakarta (jakarta.ws.rs)
    resteasy = [version: "6.2.12.Final"]
}

repositories {
    mavenCentral()
}

// Node/npm integration for UI workspace
node {
    version = '20.11.1'
    npmVersion = ''
    download = true
    workDir = file("${project.projectDir}/.gradle/nodejs")
    npmWorkDir = file("${project.projectDir}/.gradle/npm")
    nodeProjectDir = file("${project.projectDir}/src/ui")
}

// This simulates Maven's "provided" scope, until it is officially supported by Gradle
// See http://jira.codehaus.org/browse/GRADLE-784

configurations {
    provided
}

sourceSets {
    main {
        compileClasspath += configurations.provided
    }
    test {
        compileClasspath += configurations.provided
        runtimeClasspath += configurations.provided
    }
}

dependencies {
    implementation "com.squareup.dagger:dagger:1.1.0"
    // Dagger compiler is compile-time only; keep as annotation processor, not runtime
    annotationProcessor "com.squareup.dagger:dagger-compiler:1.1.0"

    implementation "com.fazecast:jSerialComm:2.10.4"

    implementation "joda-time:joda-time:2.1"

    implementation 'ch.qos.logback:logback-classic:1.1.2'
    implementation 'org.slf4j:jul-to-slf4j:1.7.10'

    implementation "org.eclipse.jetty:jetty-server:${project.jetty.version}"
    implementation "org.eclipse.jetty:jetty-servlet:${project.jetty.version}"


    // RESTEasy 6 (Jakarta): core SPI + core + servlet integration + Jackson 2 provider
    implementation ("org.jboss.resteasy:resteasy-core-spi:${project.resteasy.version}") {
        exclude group: 'org.slf4j'
    }
    implementation ("org.jboss.resteasy:resteasy-core:${project.resteasy.version}") {
        exclude group: 'org.slf4j'
    }
    implementation ("org.jboss.resteasy:resteasy-servlet-initializer:${project.resteasy.version}") {
        exclude group: 'org.slf4j'
    }
    implementation "org.jboss.resteasy:resteasy-jackson2-provider:${project.resteasy.version}"
    // FasterXML Jackson 2 core libs
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.17.2'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.17.2'
    implementation 'com.fasterxml.jackson.core:jackson-core:2.17.2'
    implementation 'commons-io:commons-io:2.11.0'

    // Lightweight native WebSocket server for modern UI transport
    implementation 'org.java-websocket:Java-WebSocket:1.5.6'

    testImplementation "org.codehaus.groovy:groovy-all:2.0.5"
    testImplementation "org.testng:testng:7.10.2"
    testImplementation "org.mockito:mockito-all:1.9.5"

    testImplementation('org.seleniumhq.selenium:selenium-java:4.35.0') { // https://www.selenium.dev/downloads/
        exclude group: 'org.eclipse.jetty'
    }

    testImplementation 'io.github.bonigarcia:webdrivermanager:5.9.2'

    testImplementation 'io.cucumber:cucumber-java:7.14.0'
    testImplementation 'io.cucumber:cucumber-testng:7.14.0'
}

// Show deprecated API usage details during compilation
tasks.withType(JavaCompile).configureEach {
    options.compilerArgs << '-Xlint:deprecation'
}

distributions {
    main {
        distributionBaseName = 'scoreboard'
        contents {
            exclude("logs")
        }
    }
}

// Disable legacy zip/tar distributions; prefer jpackage app-image
gradle.afterProject {
    tasks.matching { it.name in [
            'distZip','distTar','shadowDistZip','shadowDistTar','startShadowScripts'
    ] }.configureEach { enabled = false }
}

test {
    useTestNG()

    jvmArgs '--add-opens', 'java.base/java.lang=ALL-UNNAMED', '--add-opens', 'java.base/java.util.concurrent=ALL-UNNAMED', '--add-opens', 'java.base/java.util=ALL-UNNAMED'

    enableAssertions = true
}
tasks.named('run') {
    args 'start'
    workingDir = file('src/main/dist')
}
tasks.named('wrapper') {
    gradleVersion = '8.7'
}

// UI build tasks using Node Gradle plugin
tasks.register('uiBuild', com.github.gradle.node.npm.task.NpmTask) {
    group = 'build'
    description = 'Builds the TypeScript UI and outputs to src/main/dist/web-generated'
    dependsOn tasks.named('npmInstall')
    npmCommand = ['run', 'build']
    inputs.dir('src/ui/src')
    inputs.file('src/ui/package.json')
    inputs.file('src/ui/package-lock.json')
    inputs.file('src/ui/vite.config.ts')
    inputs.file('src/ui/tsconfig.json')
    outputs.dir('src/main/dist/web-generated')
}

tasks.register('uiCheck', com.github.gradle.node.npm.task.NpmTask) {
    group = 'verification'
    description = 'Runs lint, tests, and typecheck on the TypeScript UI'
    dependsOn tasks.named('npmInstall')
    npmCommand = ['run', 'check']
    inputs.dir('src/ui/src')
    inputs.file('src/ui/package.json')
    inputs.file('src/ui/.eslintrc.json')
    inputs.file('src/ui/tsconfig.json')
}

tasks.register('uiTest', com.github.gradle.node.npm.task.NpmTask) {
    group = 'verification'
    description = 'Runs Vitest unit tests for the TypeScript UI'
    dependsOn tasks.named('npmInstall')
    npmCommand = ['run', 'test']
    inputs.dir('src/ui/src')
    inputs.file('src/ui/package.json')
}

tasks.register('uiClean', Delete) {
    group = 'build'
    description = 'Cleans UI build outputs'
    delete 'src/main/dist/web-generated'
    delete 'src/ui/node_modules/.vite'
}

// Wire UI tasks into Java build lifecycle
tasks.named('processResources') {
    dependsOn tasks.named('uiBuild')
}

tasks.named('clean') {
    dependsOn tasks.named('uiClean')
}

// Ensure the fat jar has the proper Main-Class and default args can be passed via launcher/installer
tasks.named('shadowJar') {
    archiveClassifier.set('all')
    manifest {
        attributes(
                'Main-Class': application.mainClass.get()
        )
    }
}

// Fallback packaging: build a Windows EXE using jpackage with the full JRE from JAVA_HOME.
// This bypasses jlink/JPMS issues from legacy RESTEasy modules at the cost of a larger runtime.
tasks.register('jpackageFullJre', Exec) {
    dependsOn tasks.named('shadowJar')

    doFirst {
        // Normalize version for Windows FILEVERSION (requires 3-4 numeric parts)
        def rawVersion = project.version.toString()
        def parts = rawVersion.tokenize('.')
        while (parts.size() < 3) { parts << '0' }
        if (parts.size() > 4) { parts = parts.take(4) }
        def winVersion = parts.join('.')

        def javaHome = System.getenv('JAVA_HOME')
        if (!javaHome) {
            throw new GradleException('JAVA_HOME must be set to a JDK 21 path for jpackageFullJre.')
        }
        // Use Provider-based build directories (avoid deprecated buildDir)
        def libsDir = layout.buildDirectory.dir('libs').get().asFile
        if (!libsDir.exists()) libsDir.mkdirs()
        // Clean any previous app image to allow jpackage to recreate it
        def destDir = layout.buildDirectory.dir('jpackage').get().asFile
        destDir.mkdirs()
        def appImageDir = new File(destDir, 'scoreboard')
        if (appImageDir.exists()) {
            logger.lifecycle("Deleting previous app image: ${appImageDir}")
            project.delete(appImageDir)
        }

        def mainJar = "${project.name}-${project.version}-all.jar"
        def resourceDirPath = file('src/main/dist').absolutePath
        def iconPath = file('src/main/resources/scoreboard.ico').absolutePath

        // Build an app-image (no installer) with a custom icon and bundled full JRE
        commandLine('jpackage',
                '--type', 'app-image',
                '--name', 'scoreboard',
                '--vendor', 'Bremerton Ice Arena',
                '--input', libsDir.absolutePath,
                '--main-jar', mainJar,
                '--main-class', application.mainClass.get(),
                '--runtime-image', javaHome,
                '--java-options', '-Dscoreboard.showDialog=true',
                '--icon', iconPath,
                '--dest', destDir.absolutePath
        )
    }

    doLast {
        // jpackage does not copy resourceDir content into app-image consistently across JDKs.
        // Ensure our static assets (web, conf, bin) are present next to the launcher.
        def appImageDir = new File(layout.buildDirectory.dir('jpackage').get().asFile, 'scoreboard')
        copy {
            from(file('src/main/dist'))
            into(appImageDir)
        }
    }
}

// Zip the jpackage app-image for distribution
tasks.register('appImageZip', Zip) {
    group = 'distribution'
    description = 'Creates a zip of the jpackage app-image for handoff.'
    dependsOn tasks.named('jpackageFullJre')

    from(layout.buildDirectory.dir('jpackage/scoreboard'))
    archiveFileName.set("scoreboard-${project.version}-app-image.zip")
    destinationDirectory.set(layout.buildDirectory.dir('artifacts'))
}

// Run UI tests against the packaged executable (app-image)
tasks.register('uiTestPackaged', Test) {
    group = 'verification'
    description = 'Runs Cucumber UI tests against the packaged app-image.'

    useTestNG()
    shouldRunAfter tasks.named('test')
    dependsOn tasks.named('jpackageFullJre')

    // Only run the UI integration tests
    filter {
        includeTestsMatching 'canfield.bia.UiIntegrationTest'
    }

    // Keep a handle to the external process
    def procRef = [null]

    doFirst {
        def appDir = layout.buildDirectory.dir('jpackage/scoreboard').get().asFile
        def exe = new File(appDir, 'scoreboard.exe')
        if (!exe.exists()) {
            throw new GradleException("Packaged executable not found: ${exe}")
        }

        logger.lifecycle("Starting packaged scoreboard: ${exe}")
        def pb = new ProcessBuilder(exe.absolutePath)
        pb.directory(appDir)
        pb.redirectErrorStream(true)
        // Inherit environment; ensure headless behavior by default
        pb.environment().put('JAVA_TOOL_OPTIONS', (pb.environment().get('JAVA_TOOL_OPTIONS') ?: '') + ' -Djava.awt.headless=true')
        def p = pb.start()
        procRef[0] = p

        // Async reader to avoid process blocking on output buffer
        Thread.startDaemon('scoreboard-stdout') {
            p.inputStream.withReader { it.eachLine { /* swallow */ } }
        }

        // Wait for server readiness
        def url = new URL('http://localhost:8080/')
        long deadline = System.currentTimeMillis() + 30000
        boolean up = false
        while (System.currentTimeMillis() < deadline && !up) {
            try {
                def conn = url.openConnection()
                conn.setConnectTimeout(500)
                conn.setReadTimeout(500)
                conn.getInputStream().close()
                up = true
            } catch (IOException ignored) {
                Thread.sleep(200)
            }
        }
        if (!up) {
            // If it failed to start, dump a hint and abort
            try { p.destroyForcibly() } catch (Throwable ignored) {}
            throw new GradleException('Server failed to start on http://localhost:8080 within 30s')
        }
        logger.lifecycle('Packaged server is up on http://localhost:8080')
    }

    doLast {
        def p = procRef[0]
        if (p != null) {
            logger.lifecycle('Stopping packaged scoreboard process')
            try {
                p.destroy()
                if (!p.waitFor(5, java.util.concurrent.TimeUnit.SECONDS)) {
                    p.destroyForcibly()
                }
            } catch (Throwable ignored) {}
        }
    }
}

// Create a trimmed runtime image and a Windows installer/app image via jpackage
jlink {
    imageName = 'scoreboard'
    // Keep defaults minimal; plugin will infer required JDK modules for non-modular app

    launcher {
        name = 'scoreboard'
        // Default CLI args for launching the app
        args = ['start']
    }

task runComPortListener(type: JavaExec) {
    group = "application"
    description = "Runs the COM port listener test script"
    classpath = sourceSets.test.runtimeClasspath
    mainClass = "canfield.bia.ComPortListener"
    standardOutput = System.out
    errorOutput = System.err
    if (project.hasProperty('comPort')) {
        args = [project.property('comPort')]
    }
}

task runJvmArch(type: JavaExec) {
    group = "application"
    description = "Prints the JVM architecture"
    classpath = sourceSets.test.runtimeClasspath
    mainClass = "canfield.bia.JvmArch"
    standardOutput = System.out
    errorOutput = System.err
}

// Stop any running packaged scoreboard app-image processes
tasks.register('stopPackaged') {
    group = 'application'
    description = 'Stops running scoreboard.exe processes from the packaged app-image in build/jpackage.'

    doLast {
        def appDir = layout.buildDirectory.dir('jpackage/scoreboard').get().asFile
        def appRoot = appDir.absolutePath.replace('\\','/').toLowerCase()
        def pids = [] as Set
        ProcessHandle.allProcesses().forEach { ph ->
            try {
                def info = ph.info()
                def cmd = info.command().orElse("")
                def cmdLine = info.commandLine().orElse("")
                def cmdL = cmd.replace('\\','/').toLowerCase()
                def clL = cmdLine.replace('\\','/').toLowerCase()
                boolean match = false
                if (cmdL.endsWith('/scoreboard.exe') && cmdL.contains(appRoot)) match = true
                if (!match && clL.contains(appRoot)) match = true
                if (!match && clL.contains('scoreboard-') && clL.contains('-all.jar')) match = true
                if (match) {
                    // Try graceful then forceful termination
                    try { if (ph.supportsNormalTermination()) ph.destroy() } catch (Throwable ignored) {}
                    try { ph.onExit().get(2, java.util.concurrent.TimeUnit.SECONDS) } catch (Throwable ignored) {}
                    try { if (ph.isAlive()) ph.destroyForcibly() } catch (Throwable ignored) {}
                    pids.add(ph.pid())
                }
            } catch (Throwable ignored) {}
        }
        if (pids.isEmpty()) {
            logger.lifecycle('No packaged scoreboard process found to stop.')
        } else {
            logger.lifecycle("Stopped packaged scoreboard processes: ${pids}")
        }
    }
}

    // Keep default merged-module behavior, but we will provide a fallback task
    // below that uses the full JRE if needed.

    // Trim the runtime image a bit
    options = ['--strip-debug', '--no-header-files', '--no-man-pages']

    // Package static assets (web UI, scripts, configs) next to the app image
    jpackage {
        // Produce a Windows EXE installer by default (no WiX required)
        installerType = 'exe'

        appVersion = project.version.toString()
        vendor = 'Bremerton Ice Arena'
        imageName = 'scoreboard'
        installerName = "scoreboard-${project.version}"

        // Copy everything from src/main/dist into the packaged app image/installation directory
        resourceDir = file('src/main/dist')

        // Common Windows niceties;
        installerOptions = ['--win-shortcut', '--win-menu', '--win-console']
    }
}
